<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RED UNAP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
        }
        
        .navbar {
            background: #333;
            color: white;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-links button {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .nav-links button:hover {
            background: white;
            color: #333;
        }
        
        .nav-links button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }
        
        .message {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
        }
        
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .auth-forms {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            border: 1px solid #ddd;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }
        
        .form-group button {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .guest-btn {
            background: #28a745 !important;
        }
        
        .logout-btn {
            background: #dc3545 !important;
        }
        
        .dashboard {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        
        .stat-item {
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
            flex: 1;
        }
        
        .stories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn-create {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
        }
        
        .story-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        
        .story-meta {
            color: #666;
            margin-bottom: 10px;
        }
        
        .story-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-edit { background: #ffc107; color: #212529; border: none; padding: 5px 10px; cursor: pointer; }
        .btn-delete { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .btn-view { background: #17a2b8; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .btn-save { background: #28a745; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        .btn-cancel { background: #6c757d; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        
        .story-form {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .story-form input,
        .story-form textarea,
        .story-form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        
        .story-form textarea {
            min-height: 120px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row > div {
            flex: 1;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
        }
        
        .story-detail {
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
        }
        
        .detail-meta {
            color: #666;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
        }
        
        .pagination button.active {
            background: #007bff;
            color: white;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .debug-section {
            margin-top: 30px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        .debug-info {
            background: white;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navbar -->
        <nav class="navbar">
            <h1>RED UNAP</h1>
            <div class="nav-links">
                <button id="homeBtn" onclick="showHome()" disabled>Inicio</button>
                <button id="storiesBtn" onclick="showStories()" disabled>Historias</button>
                <button id="chatBtn" onclick="showChat()" disabled>Chat</button>
                <button id="logoutBtn" onclick="logout()" class="logout-btn hidden">Cerrar Sesión</button>
            </div>
        </nav>

        <!-- Mensajes -->
        <div id="messages"></div>

        <!-- Sección de Autenticación -->
        <div id="authSection" class="auth-section">
            <h2>Login</h2>
            <div class="auth-forms">
                <!-- Registro -->
                <div class="form-group">
                    <h3>Registro</h3>
                    <input type="email" id="regEmail" placeholder="Email" required>
                    <input type="password" id="regPassword" placeholder="Contraseña (mín. 6 caracteres)" required>
                    <button onclick="register()">Registrarse</button>
                </div>

                <!-- Login -->
                <div class="form-group">
                    <h3>Iniciar Sesión</h3>
                    <input type="email" id="loginEmail" placeholder="Email" required>
                    <input type="password" id="loginPassword" placeholder="Contraseña" required>
                    <button onclick="login()">Iniciar Sesión</button>
                </div>

                <!-- Invitado -->
                <div class="form-group">
                    <h3>Acceso de Invitado</h3>
                    <p>Ingresa sin credenciales con acceso limitado</p>
                    <button onclick="guestAccess()" class="guest-btn">Ingresar como Invitado</button>
                    <small>Sin acceso al Chat</small>
                </div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div id="mainContent" class="main-content hidden">
            <!-- Dashboard -->
            <div id="dashboardSection">
                <div class="dashboard">
                    <h2 id="welcomeMessage">¡Bienvenido!</h2>
                    <div class="user-info">
                        <strong>Usuario:</strong> <span id="currentUser"></span><br>
                        <strong>Rol:</strong> <span id="currentRole"></span><br>
                        <strong>Tipo:</strong> <span id="userType"></span>
                    </div>
                    <div id="statsSection" class="stats hidden">
                        <div class="stat-item">
                            <strong id="totalStories">0</strong>
                            <span>Historias</span>
                        </div>
                        <div class="stat-item">
                            <strong id="totalUsers">0</strong>
                            <span>Usuarios</span>
                        </div>
                    </div>
                    <div id="guestNotice" class="hidden">
                        <div class="message info">
                            Como invitado tienes acceso limitado. Regístrate para acceder a todas las funciones.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Historias -->
            <div id="storiesSection" class="stories-section hidden">
                <div class="stories-header">
                    <h2>Historias</h2>
                    <button id="createStoryBtn" class="btn-create hidden" onclick="showCreateForm()">
                        Crear Historia
                    </button>
                </div>

                <!-- Formulario para crear/editar historia -->
                <div id="storyForm" class="story-form hidden">
                    <h3 id="formTitle">Crear Nueva Historia</h3>
                    <form onsubmit="saveStory(event)">
                        <div class="form-row">
                            <div>
                                <input type="text" id="storyTitle" placeholder="Título de la historia" required maxlength="255">
                            </div>
                            <div>
                                <select id="storyCategory" required>
                                    <option value="">Seleccionar categoría</option>
                                </select>
                            </div>
                        </div>
                        
                        <textarea id="storySummary" placeholder="Resumen breve de la historia (opcional)" maxlength="500"></textarea>
                        
                        <textarea id="storyContent" placeholder="Contenido completo de la historia" required rows="8"></textarea>
                        
                        <input type="url" id="storyImage" placeholder="URL de imagen (opcional)">
                        
                        <div class="form-buttons">
                            <button type="submit" class="btn-save">Guardar Historia</button>
                            <button type="button" class="btn-cancel" onclick="cancelForm()">Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Vista detallada de historia -->
                <div id="storyDetail" class="story-detail hidden">
                    <div id="storyDetailContent"></div>
                    <div class="form-buttons" style="margin-top: 20px;">
                        <button class="btn-cancel" onclick="closeDetailView()">Volver a la lista</button>
                    </div>
                </div>

                <!-- Lista de historias -->
                <div id="storiesList">
                    <div class="empty-state">
                        <h3>No hay historias disponibles</h3>
                        <p>¡Sé el primero en crear una historia!</p>
                    </div>
                </div>

                <!-- Paginación -->
                <div id="paginationSection" class="pagination hidden"></div>
            </div>

            <!-- Sección de Chat -->
            <div id="chatSection" class="hidden">
                <h2>Chat</h2>
                <div class="message info">
                    <p>Función de Chat - Próximamente</p>
                    <p>Solo usuarios registrados pueden acceder</p>
                </div>
            </div>
        </div>

        <!-- Sección de Debug -->
        <div class="debug-section">
            <h3>Debug Info</h3>
            <div id="debugInfo" class="debug-info">
                API Base URL: http://localhost:3000/api
                Token almacenado: No hay token
                Estado: No autenticado
            </div>
        </div>
    </div>

    <script>
        // Configuración
        const API_BASE = 'http://localhost:3000/api';
        let currentToken = localStorage.getItem('authToken');
        let currentUser = null;
        let categories = [];
        let currentStories = [];
        let currentPage = 1;
        let editingStoryId = null;

        // Utilidades
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            messagesDiv.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent = `API Base URL: ${API_BASE}
Token almacenado: ${currentToken ? 'Sí (' + currentToken.substring(0, 20) + '...)' : 'No hay token'}
Estado: ${currentUser ? 'Autenticado como ' + currentUser.username : 'No autenticado'}
Rol: ${currentUser ? currentUser.role : 'N/A'}
Puede crear historias: ${currentUser ? canCreateStories() : 'N/A'}
Categorías cargadas: ${categories.length}
Historias actuales: ${currentStories.length}`;
        }

        function canCreateStories() {
            return currentUser && ['Admin', 'Moderator'].includes(currentUser.role);
        }

        function canEditStory(story) {
            if (!currentUser) return false;
            return ['Admin', 'Moderator'].includes(currentUser.role) || 
                   story.author_id === currentUser.id;
        }

        function updateNavigation() {
            const homeBtn = document.getElementById('homeBtn');
            const storiesBtn = document.getElementById('storiesBtn');
            const chatBtn = document.getElementById('chatBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const createStoryBtn = document.getElementById('createStoryBtn');

            if (currentUser) {
                homeBtn.disabled = false;
                storiesBtn.disabled = false;
                chatBtn.disabled = currentUser.role === 'Guest';
                logoutBtn.classList.remove('hidden');
                
                // Mostrar botón crear solo si tiene permisos
                if (canCreateStories()) {
                    createStoryBtn.classList.remove('hidden');
                } else {
                    createStoryBtn.classList.add('hidden');
                }
                
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            } else {
                homeBtn.disabled = true;
                storiesBtn.disabled = true;
                chatBtn.disabled = true;
                logoutBtn.classList.add('hidden');
                createStoryBtn.classList.add('hidden');
                
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');
            }
            
            updateDebugInfo();
        }

        // Funciones de API
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const config = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (currentToken) {
                    config.headers['Authorization'] = `Bearer ${currentToken}`;
                }

                if (data) {
                    config.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, config);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Error en la petición');
                }

                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Funciones de Autenticación
        async function register() {
            try {
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;

                if (!email || !password) {
                    showMessage('Email y contraseña son requeridos', 'error');
                    return;
                }

                const data = { email, password };

                const result = await apiCall('/auth/register', 'POST', data);
                
                currentToken = result.token;
                localStorage.setItem('authToken', currentToken);
                
                showMessage(result.message, 'success');
                await loadDashboard();
                
                // Limpiar formulario
                document.getElementById('regEmail').value = '';
                document.getElementById('regPassword').value = '';
                
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function login() {
            try {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                if (!email || !password) {
                    showMessage('Email y contraseña son requeridos', 'error');
                    return;
                }

                const result = await apiCall('/auth/login', 'POST', { email, password });
                
                currentToken = result.token;
                localStorage.setItem('authToken', currentToken);
                
                showMessage(result.message, 'success');
                await loadDashboard();
                
                // Limpiar formulario
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function guestAccess() {
            try {
                const result = await apiCall('/auth/guest', 'POST');
                
                currentToken = result.token;
                localStorage.setItem('authToken', currentToken);
                
                showMessage(result.message, 'success');
                await loadGuestDashboard();
                
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        function logout() {
            currentToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            
            showMessage('Sesión cerrada', 'info');
            updateNavigation();
        }

        // Funciones de Dashboard
        async function loadDashboard() {
            try {
                const result = await apiCall('/home/dashboard');
                
                currentUser = result.user;
                currentUser.navigation = result.navigation;
                
                document.getElementById('welcomeMessage').textContent = result.message;
                document.getElementById('currentUser').textContent = result.user.username;
                document.getElementById('currentRole').textContent = result.user.role;
                document.getElementById('userType').textContent = result.user.is_guest ? 'Invitado' : 'Registrado';
                
                if (result.stats) {
                    document.getElementById('totalStories').textContent = result.stats.totalStories;
                    document.getElementById('totalUsers').textContent = result.stats.totalUsers;
                    document.getElementById('statsSection').classList.remove('hidden');
                }
                
                document.getElementById('guestNotice').classList.add('hidden');
                
                // Cargar categorías
                await loadCategories();
                
                updateNavigation();
                
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function loadGuestDashboard() {
            try {
                const result = await apiCall('/home/guest');
                
                currentUser = result.user;
                currentUser.navigation = result.navigation;
                
                document.getElementById('welcomeMessage').textContent = result.message;
                document.getElementById('currentUser').textContent = result.user.username;
                document.getElementById('currentRole').textContent = result.user.role;
                document.getElementById('userType').textContent = 'Invitado';
                
                document.getElementById('statsSection').classList.add('hidden');
                document.getElementById('guestNotice').classList.remove('hidden');
                
                // Cargar categorías para invitados también
                await loadCategories();
                
                updateNavigation();
                
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Funciones de Categorías
            async function loadCategories() {
            try {
                const result = await apiCall('/categories');
                categories = result.categories || [];
                updateCategorySelect();
            } catch (error) {
                console.error('Error cargando categorías:', error);
                // Fallback a categorías hardcodeadas si falla la API
                categories = [
                { id: 1, name: 'General' },
                { id: 2, name: 'Tecnología' },
                { id: 3, name: 'Deportes' },
                { id: 4, name: 'Política' },
                { id: 5, name: 'Entretenimiento' }
                ];
                updateCategorySelect();
            }
            }

        function updateCategorySelect() {
            const select = document.getElementById('storyCategory');
            select.innerHTML = '<option value="">Seleccionar categoría</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        // Funciones de Historias
        async function loadStories(page = 1) {
            try {
                currentPage = page;
                const result = await apiCall(`/stories?page=${page}&limit=10`);
                
                currentStories = result.stories || [];
                
                renderStories();
                renderPagination(result.pagination);
                
            } catch (error) {
                showMessage(error.message, 'error');
                document.getElementById('storiesList').innerHTML = `
                    <div class="empty-state">
                        <h3>❌ Error al cargar historias</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderStories() {
            const storiesList = document.getElementById('storiesList');
            
            if (currentStories.length === 0) {
                storiesList.innerHTML = `
                    <div class="empty-state">
                        <h3>📚 No hay historias disponibles</h3>
                        <p>${canCreateStories() ? '¡Sé el primero en crear una historia!' : 'Aún no hay contenido publicado.'}</p>
                    </div>
                `;
                return;
            }
            
            storiesList.innerHTML = currentStories.map(story => `
                <div class="story-item">
                    <h4>${story.title}</h4>
                    <div class="story-meta">
                        Por: ${story.author || 'Anónimo'} | 
                        Categoría: ${story.category || 'General'} | 
                        ${new Date(story.published_at).toLocaleDateString('es-ES')}
                    </div>
                    <div class="story-summary">${story.summary || 'Sin resumen disponible'}</div>
                    <div class="story-actions">
                        <button class="btn-view" onclick="viewStory(${story.id})">Ver</button>
                        ${canEditStory(story) ? `
                            <button class="btn-edit" onclick="editStory(${story.id})">Editar</button>
                            <button class="btn-delete" onclick="deleteStory(${story.id})">Eliminar</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderPagination(pagination) {
            const paginationSection = document.getElementById('paginationSection');
            
            if (!pagination || pagination.totalPages <= 1) {
                paginationSection.classList.add('hidden');
                return;
            }
            
            paginationSection.classList.remove('hidden');
            
            let paginationHTML = '';
            
            // Botón anterior
            if (pagination.page > 1) {
                paginationHTML += `<button onclick="loadStories(${pagination.page - 1})">‹ Anterior</button>`;
            }
            
            // Números de página
            for (let i = 1; i <= pagination.totalPages; i++) {
                const activeClass = i === pagination.page ? 'active' : '';
                paginationHTML += `<button class="${activeClass}" onclick="loadStories(${i})">${i}</button>`;
            }
            
            // Botón siguiente
            if (pagination.page < pagination.totalPages) {
                paginationHTML += `<button onclick="loadStories(${pagination.page + 1})">Siguiente ›</button>`;
            }
            
            paginationSection.innerHTML = paginationHTML;
        }

        // Funciones del formulario de historias
        function showCreateForm() {
            editingStoryId = null;
            document.getElementById('formTitle').textContent = 'Crear Nueva Historia';
            document.getElementById('storyForm').classList.remove('hidden');
            document.getElementById('storiesList').classList.add('hidden');
            document.getElementById('paginationSection').classList.add('hidden');
            clearForm();
        }

        function showEditForm(story) {
            editingStoryId = story.id;
            document.getElementById('formTitle').textContent = 'Editar Historia';
            document.getElementById('storyForm').classList.remove('hidden');
            document.getElementById('storiesList').classList.add('hidden');
            document.getElementById('paginationSection').classList.add('hidden');
            
            // Llenar formulario con datos existentes
            document.getElementById('storyTitle').value = story.title;
            document.getElementById('storyContent').value = story.content;
            document.getElementById('storySummary').value = story.summary || '';
            document.getElementById('storyImage').value = story.image_url || '';
            document.getElementById('storyCategory').value = story.category_id;
        }

        function clearForm() {
            document.getElementById('storyTitle').value = '';
            document.getElementById('storyContent').value = '';
            document.getElementById('storySummary').value = '';
            document.getElementById('storyImage').value = '';
            document.getElementById('storyCategory').value = '';
        }

        function cancelForm() {
            document.getElementById('storyForm').classList.add('hidden');
            document.getElementById('storiesList').classList.remove('hidden');
            if (currentStories.length > 0) {
                document.getElementById('paginationSection').classList.remove('hidden');
            }
            clearForm();
            editingStoryId = null;
        }

        async function saveStory(event) {
            event.preventDefault();
            
            try {
                const title = document.getElementById('storyTitle').value;
                const content = document.getElementById('storyContent').value;
                const summary = document.getElementById('storySummary').value;
                const image_url = document.getElementById('storyImage').value;
                const category_id = parseInt(document.getElementById('storyCategory').value);

                if (!title || !content || !category_id) {
                    showMessage('Título, contenido y categoría son requeridos', 'error');
                    return;
                }

                const storyData = {
                    title,
                    content,
                    summary: summary || undefined,
                    image_url: image_url || undefined,
                    category_id
                };

                let result;
                if (editingStoryId) {
                    // Actualizar historia existente
                    result = await apiCall(`/stories/${editingStoryId}`, 'PUT', storyData);
                    showMessage('Historia actualizada exitosamente', 'success');
                } else {
                    // Crear nueva historia
                    result = await apiCall('/stories', 'POST', storyData);
                    showMessage('Historia creada exitosamente', 'success');
                }

                cancelForm();
                await loadStories(currentPage);

            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function viewStory(storyId) {
            try {
                const result = await apiCall(`/stories/${storyId}`);
                const story = result.story;
                
                const detailContent = `
                    <h3>${story.title}</h3>
                    <div class="detail-meta">
                        <strong>Autor:</strong> ${story.author || 'Anónimo'} | 
                        <strong>Categoría:</strong> ${story.category || 'General'} | 
                        <strong>Publicado:</strong> ${new Date(story.published_at).toLocaleString('es-ES')}
                        ${story.image_url ? `<br><strong>Imagen:</strong> <a href="${story.image_url}" target="_blank">Ver imagen</a>` : ''}
                    </div>
                    ${story.summary ? `<div style="font-style: italic; margin-bottom: 15px; color: #666;">${story.summary}</div>` : ''}
                    <div class="detail-content">${story.content.replace(/\n/g, '<br>')}</div>
                `;
                
                document.getElementById('storyDetailContent').innerHTML = detailContent;
                document.getElementById('storyDetail').classList.remove('hidden');
                document.getElementById('storiesList').classList.add('hidden');
                document.getElementById('paginationSection').classList.add('hidden');
                
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        function closeDetailView() {
            document.getElementById('storyDetail').classList.add('hidden');
            document.getElementById('storiesList').classList.remove('hidden');
            if (currentStories.length > 0) {
                document.getElementById('paginationSection').classList.remove('hidden');
            }
        }

        async function editStory(storyId) {
            try {
                const result = await apiCall(`/stories/${storyId}`);
                showEditForm(result.story);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function deleteStory(storyId) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta historia? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                await apiCall(`/stories/${storyId}`, 'DELETE');
                showMessage('Historia eliminada exitosamente', 'success');
                await loadStories(currentPage);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Funciones de Navegación
        function showHome() {
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('storiesSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'none';
        }

        function showStories() {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('storiesSection').style.display = 'block';
            document.getElementById('chatSection').style.display = 'none';
            
            // Ocultar formularios y mostrar lista
            document.getElementById('storyForm').classList.add('hidden');
            document.getElementById('storyDetail').classList.add('hidden');
            document.getElementById('storiesList').classList.remove('hidden');
            
            loadStories(1);
        }

        function showChat() {
            if (currentUser && currentUser.role === 'Guest') {
                showMessage('Los invitados no pueden acceder al chat', 'error');
                return;
            }
            
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('storiesSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'block';
        }

        // Verificar autenticación al cargar
        async function checkAuth() {
            if (currentToken) {
                try {
                    const result = await apiCall('/auth/verify');
                    if (result.valid) {
                        if (result.user.role === 'Guest') {
                            await loadGuestDashboard();
                        } else {
                            await loadDashboard();
                        }
                    } else {
                        logout();
                    }
                } catch (error) {
                    logout();
                }
            }
            updateNavigation();
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
    </script>
</body>
</html>